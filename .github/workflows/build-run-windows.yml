name: Build and Run Spring Boot App on Windows

on:
  push:
    branches:
      - main

jobs:
  build-and-run:
    runs-on: self-hosted

    env:
      JAVA_HOME: 'C:\\Program Files\\Java\\jdk-17'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Set up Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn --version
        shell: cmd

      - name: Build with Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn clean install
        shell: cmd

      - name: Run Spring Boot App and Test Endpoint
        shell: powershell
        run: |
          $env:PATH="$env:JAVA_HOME\bin;" + $env:PATH
          # Start the app (runs in background)
          Start-Process -FilePath java -ArgumentList "-jar", "target\springboot-gym-html-app-github-windows-1.0.0.jar", "--server.address=0.0.0.0"
          Start-Sleep -Seconds 10
          # Test if the app is accessible
          try {
            Invoke-WebRequest -Uri http://localhost:8080/home.html -UseBasicParsing
            Write-Host "/home.html is accessible"
          } catch {
            Write-Host "Failed to access /home.html"
            Exit 1
          }

      - name: Notify Success
        if: success()
        run: echo "Spring Boot app is running and test passed!"
        shell: cmd

      - name: Notify Failure
        if: failure()
        run: echo "Build or test failed!"
        shell: cmd
