name: Build and Run Spring Boot App on Windows

on:
  push:
    branches:
      - main

jobs:
  build-and-run:
    runs-on: self-hosted

    env:
      JAVA_HOME: 'C:\\Program Files\\Java\\jdk-17'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Set up Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn --version
        shell: cmd

      - name: Build with Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn clean install
        shell: cmd

      - name: Run Spring Boot App and Test Endpoint
        shell: powershell
        run: |
          $env:PATH="$env:JAVA_HOME\bin;" + $env:PATH
          # Start Spring Boot app in background, output redirected to app.log
          Start-Process -FilePath java -ArgumentList "-jar", "target\springboot-gym-html-app-github-windows-1.0.0.jar", "--server.address=0.0.0.0" -NoNewWindow
          # Wait and retry loop for app to be ready
          $maxRetries = 30
          $retry = 0
          $appStarted = $false
          while ($retry -lt $maxRetries -and -not $appStarted) {
            Start-Sleep -Seconds 2
            try {
              $response = Invoke-WebRequest -Uri http://localhost:8080/home.html -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "/home.html is accessible"
                $appStarted = $true
              }
            } catch {
              Write-Host "Waiting for app to start... (Attempt $($retry+1) of $maxRetries)"
            }
            $retry++
          }
          if (-not $appStarted) {
            Write-Host "App did not start within expected time. Showing last 20 lines of app.log:"
            Get-Content -Path app.log -Tail 20
            Exit 1
          }

      - name: Notify Success
        if: success()
        run: echo "Spring Boot app is running and test passed!"
        shell: cmd

      - name: Notify Failure
        if: failure()
        run: echo "Build or test failed!"
        shell: cmd
