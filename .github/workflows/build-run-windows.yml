name: Java Spring Boot Build and Test home.html

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Maven 3.9.9
        uses: s4u/setup-maven-action@v1
        with:
          maven-version: '3.9.9'

      - name: Build with Maven
        run: mvn clean install

      - name: Run Spring Boot app and test home.html
        shell: pwsh
        run: |
          # Run the app in background and redirect output to a log file
          Start-Process -NoNewWindow -FilePath 'java' -ArgumentList '-jar', 'target/springboot-gym-html-app-github-windows-1.0.0.jar' -RedirectStandardOutput output.log -RedirectStandardError output.log

          Write-Host "Waiting for Spring Boot to start..."
          $retries = 10
          $success = $false

          for ($i = 0; $i -lt $retries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri http://localhost:8080/home.html -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "Successfully accessed /home.html"
                $success = $true
                break
              }
            } catch {
              Write-Host "Waiting... attempt $($i + 1) of $retries"
              Start-Sleep -Seconds 5
            }
          }

          if (-not $success) {
            Write-Host "Failed to connect to /home.html after $retries attempts"
            exit 1
          }
            
