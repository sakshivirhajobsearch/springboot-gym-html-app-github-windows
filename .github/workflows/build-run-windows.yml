name: Build and Run Spring Boot App on Windows

on:
  push:
    branches:
      - main

jobs:
  build-and-run:
    runs-on: self-hosted

    env:
      JAVA_HOME: 'C:\\Program Files\\Java\\jdk-17'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java and Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn -version
        shell: cmd

      - name: Build with Maven
        run: |
          set PATH=%JAVA_HOME%\bin;%PATH%
          mvn clean install
        shell: cmd

      - name: Run Spring Boot App and Wait for Readiness
        shell: powershell
        run: |
          $env:PATH="$env:JAVA_HOME\bin;" + $env:PATH
          $process = Start-Process -FilePath java `
            -ArgumentList @(
              "-jar", "target\springboot-gym-html-app-github-windows-1.0.0.jar",
              "--server.address=0.0.0.0",
              "--server.port=8080"
            ) `
            -NoNewWindow `
            -RedirectStandardOutput "app.log" `
            -RedirectStandardError "app_error.log" `
            -PassThru

          $maxRetries = 30
          $retry = 0
          $appStarted = $false

          while ($retry -lt $maxRetries -and -not $appStarted) {
            Start-Sleep -Seconds 2
            try {
              $response = Invoke-WebRequest -Uri http://localhost:8080/home -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "/home is accessible"
                $appStarted = $true
              }
            } catch {
              Write-Host "Waiting for app to start... (Attempt $($retry + 1) of $maxRetries)"
            }
            $retry++
          }

          if (-not $appStarted) {
            Write-Host "App did not start within expected time. Showing last 20 lines of app.log:"
            Get-Content -Path app.log -Tail 20
            Exit 1
          }

      - name: Notify Success
        run: echo "Spring Boot app is running and accessible!"
        shell: cmd
