name: Deploy Spring Boot Static HTML App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # Windows self-hosted runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: List built files
        run: dir target

      - name: Start Spring Boot App in Background
        shell: powershell
        run: |
          Stop-Process -Name "java" -Force -ErrorAction SilentlyContinue
          $jar = Get-ChildItem -Path "target" -Filter "springboot-*.jar" | Select-Object -First 1
          if ($null -eq $jar) { throw "No JAR file found in target/" }
          Start-Process -FilePath "java" -ArgumentList "-jar", $jar.FullName, "--server.port=8084" `
          -RedirectStandardOutput "springboot.log" -RedirectStandardError "springboot.err"
          Start-Sleep -Seconds 20
          Get-Content springboot.log

      - name: Wait and Test App Endpoint
        shell: powershell
        run: |
          $retries = 3
          $success = $false
          for ($i = 0; $i -lt $retries; $i++) {
            try {
              $response = Invoke-WebRequest http://localhost:8084/home.html -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "App is up and serving home.html"
                $success = $true
                break
              }
            } catch {
              Write-Host "Waiting for app to start... ($($i + 1)/$retries)"
              Start-Sleep -Seconds 5
            }
          }
          if (-not $success) {
            Write-Host "App failed to start"
            Get-Content springboot.err
            throw "App failed to serve home.html"
          }
